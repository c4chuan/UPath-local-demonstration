# UPath AI 导师 API 本地接入示例

本项目是 UPath AI 导师 API 的最小前端演示，用于展示**如何在本地前端项目中直接调用生产环境 API**，完成：

- 输入并验证 API-Key
- 从 UPath 后端获取导师场景配置（示例固定为 `Math` 场景）
- 使用浏览器音视频能力与第三方 RTC SDK 加入音视频房间
- 启动本地麦克风与屏幕共享
- 通过 UPath API 唤醒 / 结束 AI 导师语音对话
- **静音检测**：长时间未检测到语音时自动结束对话，避免资源浪费
- **页面关闭处理**：关闭标签页或浏览器时自动断开连接，确保资源正确释放  

示例基于 **Vue 3 + Vite** 实现，代码尽量贴近实际业务调用，但去掉了试用页中账号体系、公告弹窗、人设调试等与 API 演示无关的复杂逻辑，方便你复制到自己的项目中。

---

## 技术栈与核心依赖

- **框架**：Vue 3  
- **构建工具**：Vite  
- **实时音视频**：浏览器音视频能力 + 第三方 RTC SDK  
- **后端 API**：直连生产环境 `https://api.upath.cn`

主要代码文件：

- `src/App.vue`：单页演示界面（API-Key 输入、状态展示、启动/结束对话按钮）  
- `src/services/api.js`：封装对 UPath 后端的 API 调用（`getScenes` / `startVoiceChat` / `stopVoiceChat` 等）

---

## 功能概览

在浏览器中打开本示例后，你可以完成如下操作：

1. **配置 API-Key**
   - 在页面顶部输入框中粘贴从 UPath 控制台获取的 API-Key  
   - 点击「保存并验证 API-Key」，前端会调用 `/api/aigc/getScenes` 进行合法性检查  
   - 验证通过后，API-Key 会保存在浏览器 `localStorage` 中，刷新页面仍会自动读取

2. **启动 AI 导师对话**
   - 点击「启动 AI 导师对话」按钮  
   - 前端会自动执行以下步骤：
     1. 使用当前 API-Key 调用 `getScenes(scene_name="Math")` 获取「数学老师」场景配置  
     2. 使用返回的 RTC 配置（AppId / RoomId / UserId / Token）创建 RTC 引擎并加入房间  
     3. 启动本地麦克风采集  
     4. 调用浏览器的 `getDisplayMedia` 接口，打开「选择窗口/屏幕」弹窗并启动屏幕共享  
     5. 调用 `/api/aigc/proxy?Action=StartVoiceChat` 唤醒 AI 导师语音对话  
   - 成功后页面会显示：  
     - 连接状态：已连接  
     - 当前场景：返回的场景名称或 ID  
     - 屏幕共享：已开启 / 未开启  

3. **结束 AI 导师对话**
   - 再次点击同一个按钮（此时文案为「结束 AI 导师对话」）
   - 前端会：
     1. 调用 `/api/aigc/proxy?Action=StopVoiceChat` 通知后端停止对话
     2. 停止屏幕共享与音频采集
     3. 退出 RTC 房间并销毁 RTC 引擎实例
   - 状态恢复为「未连接」，屏幕共享状态为「未开启」

4. **静音检测与自动结束**
   - 对话过程中，系统会持续监测麦克风音量
   - 当连续 2 分钟未检测到语音时（音量低于阈值），页面会显示黄色警告条，提示剩余时间
   - 若在最后 30 秒内仍未检测到语音，对话将自动结束
   - 一旦检测到用户说话，倒计时会立即重置
   - 此功能可避免用户忘记手动结束对话造成的资源浪费

5. **页面关闭自动断开**
   - 当用户关闭浏览器标签页或窗口时，系统会自动调用 `StopVoiceChat` 接口
   - 使用 `keepalive: true` 确保请求在页面卸载时仍能发送成功
   - 无需用户手动操作，确保后端资源及时释放

---

## 本地运行

### 1. 安装依赖

在项目根目录 `UPath-local-demonstration` 下执行：

```bash
npm install
```

### 2. 启动开发服务器

```bash
npm run dev
```

终端会输出本地访问地址（通常是 `http://localhost:5173`），在浏览器中打开即可看到示例界面。

### 3. 构建生产包

```bash
npm run build
```

打包结果将输出到 `dist/` 目录，可配合静态资源服务器部署。

---

## 使用步骤（前端 + UPath 控制台）

1. 在 UPath 控制台中创建或获取一个可用的 **API-Key**，确保具备访问 `Math` 场景的权限。  
2. 启动本示例项目（`npm run dev`），用浏览器打开本地地址。  
3. 在页面顶部输入框粘贴 API-Key，点击「保存并验证 API-Key」，等待验证成功提示。  
4. 点击「启动 AI 导师对话」，在浏览器弹出的屏幕共享授权框中选择一个窗口或屏幕并点击「共享」。  
5. 等待状态显示为「已连接」，此时 AI 导师已经处于工作状态，可按照业务需要在后端观察调用情况或扩展前端 UI。  
6. 测试完成后点击「结束 AI 导师对话」，确保连接与资源正确释放。  

---

## 如何在自己的项目中复用

你可以参考以下方式将本示例集成到你的实际业务项目中：

1. **复制 API 封装逻辑**
   - 将 `src/services/api.js` 拷贝到你的项目中  
   - 根据需要调整：
     - API 基础地址（默认 `https://api.upath.cn`）  
     - 本地存储的 key 名称  
     - 是否增加更多业务接口

2. **复制核心调用流程**
   - 在你自己的组件中，参考 `src/App.vue` 的顺序：
     1. 验证并保存 API-Key  
     2. 调用 `getScenes` 获取场景配置  
     3. 使用 RTC SDK 创建引擎并加入房间  
     4. 启动音频采集与屏幕共享  
     5. 调用 `startVoiceChat` / `stopVoiceChat` 控制 AI 导师对话  

3. **替换场景 / UI**
   - 将示例中固定的 `DEFAULT_SCENE_NAME = 'Math'` 替换为你自己的场景名称。  
   - 根据你的产品设计，替换或扩展页面样式与交互（示例仅提供最小可运行版本）。  

---

## 常见问题

1. **启动对话时没有弹出屏幕共享窗口？**
   - 确认浏览器是否支持 `navigator.mediaDevices.getDisplayMedia`（建议使用最新版 Chrome / Edge）。  
   - 检查是否误点了「拒绝」或在地址栏关闭了屏幕共享权限。  
   - 可以打开浏览器 DevTools 控制台查看是否有「浏览器不支持屏幕共享」相关报错。  

2. **API-Key 验证失败？**
   - 检查是否从 UPath 控制台完整复制了 Key（长度通常较长）。  
   - 确认该 Key 是否有访问对应场景（如 `Math`）的权限。  
   - 观察网络面板中 `/api/aigc/getScenes` 请求的响应内容，查看错误信息。

3. **RTC 加入房间失败或没有声音？**
   - 确认本机麦克风可用且浏览器已授予麦克风权限。  
   - 检查返回的 RTC 配置是否完整（AppId / RoomId / UserId / Token）。  
   - 若在公司网络环境中，可能需要额外放通 RTC 相关端口。

---

## 注意事项

- 本示例**直接连线上生产环境 API**，请勿在不可信环境中泄露你的 API-Key。  
- 建议在真实业务项目中增加：  
  - API-Key 管理与权限控制  
  - 更完善的错误提示与重试机制  
  - 监控与埋点，用于追踪 AI 导师对话质量与调用量  

如需查看更完整的试用界面（包含试用模式、公告、人设调试等），可以参考主仓库 `frontend` 中的 `TrialView.vue` 和相关 `composables` / `services` 实现。

